<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    {% load static %}

    <link rel="stylesheet" href="{% static 'chat/chat.css' %}">
</head>
<body>

{% include 'navbar.html' %}

<div class="container mt-5" style="padding-top: 80px;">
  <div class="chat-container">
    <div class="chat-list">
      {% for chat in chats %}
        {% for user in chat.participants.all %}
          {% if user != request.user %}
            <a href="{% url 'chat_page_with_id' chat.id %}"
               class="chat-list-item {% if chat.id == active_chat.id %}active{% endif %}">
              {% if user.profile.profile_image %}
                <img src="{{ user.profile.profile_image.url }}" alt="Avatar" class="avatar">
              {% else %}
                <img src="https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png" alt="Avatar" class="avatar">
              {% endif %}
              <div class="chat-preview">
                <div class="username {% if chat.id == active_chat.id %}active-text{% endif %}">
                  {{ user.profile.first_name }}
                </div>
                <div class="last-message {% if chat.id == active_chat.id %}active-text{% endif %}">
                  {% with chat.messages.last as last_message %}
                    {% if last_message %}
                      {{ last_message.content|truncatechars:40 }}
                    {% else %}
                      Нет сообщений
                    {% endif %}
                  {% endwith %}
                </div>
              </div>
            </a>
          {% endif %}
        {% endfor %}
      {% endfor %}
    </div>

    <div class="chat-box">
      {% if active_chat %}
        <div class="chat-header">
          {% for user in active_chat.participants.all %}
            {% if user != request.user %}
              <div class="user-info">
                {% if user.profile.profile_image %}
                  <img src="{{ user.profile.profile_image.url }}" alt="Avatar" class="avatar">
                {% else %}
                  <img src="https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png" alt="Avatar" class="avatar">
                {% endif %}
                <span class="username">{{ user.profile.first_name }}</span>
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <div class="messages" id="chat-box">
          {% for message in active_chat.messages.all %}
            {% if message.sender == request.user %}
<div class="d-flex justify-content-end mb-2">
  <div class="message-bubble bg-success text-white d-flex align-items-center justify-content-between">
    <span class="message-content">{{ message.content }}</span>
    <span class="timestamp">{{ message.timestamp|date:"H:i" }}</span>
  </div>
</div>
            {% else %}
<div class="d-flex justify-content-start mb-2">
  <div class="message-bubble bg-light text-dark d-flex align-items-center justify-content-between">
    <span class="message-content">{{ message.content }}</span>
    <span class="timestamp">{{ message.timestamp|date:"H:i" }}</span>
  </div>
</div>
            {% endif %}
          {% endfor %}
        </div>

        <div class="message-input">
          <input type="text" id="message-input" placeholder="Написать сообщение...">
          <button onclick="sendMessage()">Отправить</button>
        </div>
      {% else %}
        <p>Выберите чат слева или начните новый разговор</p>
      {% endif %}
    </div>
  </div>
</div>

{% if active_chat %}
<script>
  const chatId = "{{ active_chat.id }}";
  const socket = new WebSocket(`ws://${window.location.host}/ws/chat/${chatId}/`);

  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const box = document.getElementById("chat-box");
    const isMine = data.sender === "{{ request.user.username }}";
    const alignClass = isMine ? 'justify-content-end' : 'justify-content-start';
    const bubbleClass = isMine ? 'bg-success text-white' : 'bg-light text-dark';
    const now = new Date();
    const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    const msgHTML = `
      <div class="d-flex ${alignClass} mb-2">
        <div class="message-bubble ${bubbleClass}">
          <div>${data.message}</div>
          <div class="timestamp">${time}</div>
        </div>
      </div>
    `;
    box.innerHTML += msgHTML;
    box.scrollTop = box.scrollHeight;
  };

  function sendMessage() {
    const input = document.getElementById("message-input");
    const message = input.value.trim();
    if (message === "") return;
    socket.send(JSON.stringify({ message }));
    input.value = '';
  }
</script>
{% endif %}

</body>
</html>
